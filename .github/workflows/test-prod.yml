name: ðŸ§ª Test with Prod

on:
  push:
    branches: [main]

jobs:
  deployment:
    name: Test the code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Go
        uses: actions/setup-go@v6
        with: { go-version-file: go.mod }

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.4"
          terraform_wrapper: false

      - name: Test with coverage (prod - just checking it will works, no env missing etc)
        run: go test -parallel 40 -timeout 30m -coverprofile=coverage.txt -coverpkg=./... ./...
        env:
          SPACELIFT_API_KEY_ENDPOINT: ${{ vars.SPACELIFT_API_KEY_ENDPOINT }}
          SPACELIFT_API_KEY_ID: ${{ secrets.V20240227_PROD_SPACELIFT_API_KEY_ID }}
          SPACELIFT_API_KEY_SECRET: ${{ secrets.V20240227_PROD_SPACELIFT_API_KEY_SECRET }}
          SPACELIFT_PROVIDER_TEST_IPS: ${{ secrets.V20240227_PROD_SPACELIFT_PROVIDER_TEST_IPS }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_NAME: "Azure DevOps Default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_ID: "azure-devops-default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_USERFACINGHOST: "https://azure-devops-default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_ORGANIZATIONURL:  ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_ORGANIZATIONURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_DEFAULT_USEGITCHECKOUT: "false"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_NAME: "Azure DevOps Space level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_ID: "azure-devops-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_SPACE: "tests-01HPE6H08F8HR8PJR78DPYR3TC"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_USERFACINGHOST: "https://azure-devops-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_ORGANIZATIONURL:  ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_ORGANIZATIONURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_SPACELEVEL_USEGITCHECKOUT: "false"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_DEFAULT_NAME: "Bitbucket Cloud Default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_DEFAULT_ID: "bitbucket-cloud-default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_DEFAULT_USERNAME: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_USERNAME }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_DEFAULT_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_DEFAULT_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_DEFAULT_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_NAME: "Bitbucket Cloud Space level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_ID: "bitbucket-cloud-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_SPACE: "tests-01HPE6H08F8HR8PJR78DPYR3TC"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_USERNAME: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_USERNAME }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_SPACELEVEL_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_NAME: "Bitbucket Data Center"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_ID: "bitbucket-data-center"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_USERNAME: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_USERNAME }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_USERFACINGHOST: "http://bitbucket-datacenter-default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_APIHOST: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_APIHOST }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_DEFAULT_USEGITCHECKOUT: "false"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_NAME: "Bitbucket Datancenter Space Level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_ID: "bitbucket-datancenter-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_SPACE: "tests-01HPE6H08F8HR8PJR78DPYR3TC"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_USERNAME: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_USERNAME }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_USERFACINGHOST: "http://bitbucket-datacenter-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_APIHOST: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_APIHOST }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_ACCESSTOKEN: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_ACCESSTOKEN }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_SPACELEVEL_USEGITCHECKOUT: "false"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_NAME: "GitHub Default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_ID: "github-default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_APIHOST: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_APIHOST }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_APPID: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_APPID }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_DEFAULT_USEGITCHECKOUT: "true"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_NAME: "GitHub Space Level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_ID: "github-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_SPACE: "tests-01HPE6H08F8HR8PJR78DPYR3TC"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_APIHOST: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_APIHOST }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_APPID: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_APPID }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_SPACELEVEL_USEGITCHECKOUT: "true"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_NAME: "GitLab Default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_ID: "gitlab-default"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_APIHOST: "https://gitlab.com"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_TOKEN: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_TOKEN }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_DEFAULT_USEGITCHECKOUT: "true"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_NAME: "GitLab Space Level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_ID: "gitlab-space-level"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_SPACE: "tests-01HPE6H08F8HR8PJR78DPYR3TC"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_APIHOST: "https://gitlab.com"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_TOKEN: ${{ secrets.COMMON_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_TOKEN }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_WEBHOOKSECRET: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_WEBHOOKSECRET }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_WEBHOOKURL: ${{ secrets.PROD_SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_WEBHOOKURL }}
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_VCSCHECKS: "INDIVIDUAL"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_SPACELEVEL_USEGITCHECKOUT: "true"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_REPOSITORY_NAME: "spacelift-ci"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_REPOSITORY_NAMESPACE: "spacelift-ci"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_AZUREDEVOPS_REPOSITORY_BRANCH: "main"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_REPOSITORY_NAME: "empty"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_REPOSITORY_NAMESPACE: "thespacelift"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETCLOUD_REPOSITORY_BRANCH: "master"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_REPOSITORY_NAME: "tfprovider-test"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_REPOSITORY_NAMESPACE: "E2E"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_BITBUCKETDATACENTER_REPOSITORY_BRANCH: "master"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_REPOSITORY_NAME: "empty"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_REPOSITORY_NAMESPACE: "spacelift-ci-org"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITHUBENTERPRISE_REPOSITORY_BRANCH: "main"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_REPOSITORY_NAME: "multimodule"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_REPOSITORY_NAMESPACE: "spacelift-ci"
          SPACELIFT_PROVIDER_TEST_SOURCECODE_GITLAB_REPOSITORY_BRANCH: "main"
